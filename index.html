<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>User Chat</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, push, onValue, update, get, set } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

/* ----------- FIREBASE ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyAqfguS1ucAtklcl06eB1JIWQr46XMpe7g",
  authDomain: "safe-chat-c0b9c.firebaseapp.com",
  databaseURL: "https://safe-chat-c0b9c-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "safe-chat-c0b9c",
  storageBucket: "safe-chat-c0b9c.firebasestorage.app",
  messagingSenderId: "119640275300",
  appId: "1:119640275300:web:20ae984f4af1ffe6a62271"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ----------- USERNAME ---------------- */
let userId = localStorage.getItem("username");
if (!userId) {
  userId = prompt("Enter your username:").trim();
  if (!userId) userId = "guest_" + Date.now();
  localStorage.setItem("username", userId);
}

/* ----------- LAST ACTIVE ---------------- */
function updateLastActive() {
  update(ref(db, "chats/" + userId), { lastActive: Date.now() });
}

/* ----------- SOUND EFFECTS ---------------- */
const sendSound = new Audio("https://www.soundjay.com/buttons/sounds/button-3.mp3"); // send sound
const receiveSound = new Audio("https://www.soundjay.com/buttons/sounds/button-09.mp3"); // receive sound

/* ----------- LOAD MESSAGES ---------------- */
const msgsBox = document.getElementById("msgs");

function loadMessages() {
  onValue(ref(db, "chats/" + userId), snap => {
    msgsBox.innerHTML = "";
    snap.forEach(m => {
      const val = m.val();
      if (!val || !val.text) return; 
      const d = document.createElement("div");
      d.className = val.from === "admin" ? "msg admin" : "msg user";
      d.innerText = val.text;

      // simple fade-in animation
      d.style.opacity = 0;
      d.style.transform = "translateY(20px)";
      msgsBox.appendChild(d);
      setTimeout(() => {
        d.style.transition = "all 0.3s ease";
        d.style.opacity = 1;
        d.style.transform = "translateY(0)";
      }, 50);

      if (val.from === "admin") receiveSound.play();
    });
    msgsBox.scrollTop = msgsBox.scrollHeight;
  });
}

/* ----------- SEND MESSAGE WITH BLOCK CHECK ---------------- */
window.sendMsg = async () => {
  const input = document.getElementById("text");
  if (!input.value) return;

  const snapshot = await get(ref(db, "chats/" + userId + "/blocked"));
  if (snapshot.exists() && snapshot.val() === true) {
    alert("You are blocked by admin! ❌");
    return;
  }

  updateLastActive();

  push(ref(db, "chats/" + userId), {
    from: "user",
    text: input.value,
    time: Date.now()
  });

  sendSound.play(); // play send sound
  input.value = "";
  setTypingStatus(false); // reset typing on send
};

/* ----------- TYPING INDICATOR ---------------- */
const typingIndicator = document.createElement("div");
typingIndicator.id = "typingIndicator";
typingIndicator.style.fontStyle = "italic";
typingIndicator.style.color = "grey";
typingIndicator.style.margin = "5px 0";
typingIndicator.style.display = "none";
document.querySelector(".msgs").appendChild(typingIndicator);

function setTypingStatus(isTyping) {
  set(ref(db, "typingStatus/" + userId), isTyping);
}

const messageInput = document.getElementById('text');
messageInput.addEventListener('input', () => {
  setTypingStatus(true);
  clearTimeout(window.typingTimeout);
  window.typingTimeout = setTimeout(() => setTypingStatus(false), 3000);
});

// Listen for other users typing
const typingRef = ref(db, 'typingStatus');
onValue(typingRef, (snapshot) => {
  const data = snapshot.val();
  const otherTyping = Object.keys(data || {}).some(id => id !== userId && data[id]);
  if (otherTyping) {
    typingIndicator.style.display = 'block';
    typingIndicator.innerText = "Admin is typing...";
  } else {
    typingIndicator.style.display = 'none';
  }
});

/* ----------- INIT ---------------- */
window.onload = () => {
  updateLastActive();
  setInterval(updateLastActive, 30000);
  loadMessages();
};
</script>

<style>
body{margin:0;font-family:Poppins;background:#0b0a1a;color:#fff}
.app{display:flex;flex-direction:column;height:100vh}
.header{padding:14px;background:#120c22;text-align:center;font-weight:600}
.msgs{flex:1;padding:14px;overflow:auto;display:flex;flex-direction:column}
.msg{background:linear-gradient(135deg,#ff2f6d,#ff8a00);padding:10px;border-radius:14px;margin-bottom:8px;max-width:70%;word-wrap:break-word;animation:fadeIn 0.3s ease forwards}
.msg.user{background:linear-gradient(135deg,#1e90ff,#00d4ff);margin-left:auto}
.input{display:flex;padding:10px}
input{flex:1;padding:10px;border-radius:20px;border:none;outline:none}
button{margin-left:10px;border:none;border-radius:50%;width:40px;background:#ff2f6d;color:#fff;font-size:18px;cursor:pointer;transition:all 0.2s}
button:hover{transform:scale(1.1)}

@keyframes fadeIn {
  0%{opacity:0;transform:translateY(20px)}
  100%{opacity:1;transform:translateY(0)}
}
</style>
</head>

<body>
<div class="app">
  <div class="header">User Chat</div>
  <div class="msgs" id="msgs"></div>

  <div class="input">
    <input id="text" placeholder="Type message..." />
    <button onclick="sendMsg()">➤</button>
  </div>
</div>
</body>
</html>
