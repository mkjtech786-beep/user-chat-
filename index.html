<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>User Chat</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, push, onValue, update, get } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

/* ----------- FIREBASE ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyAqfguS1ucAtklcl06eB1JIWQr46XMpe7g",
  authDomain: "safe-chat-c0b9c.firebaseapp.com",
  databaseURL: "https://safe-chat-c0b9c-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "safe-chat-c0b9c",
  storageBucket: "safe-chat-c0b9c.firebasestorage.app",
  messagingSenderId: "119640275300",
  appId: "1:119640275300:web:20ae984f4af1ffe6a62271"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ----------- USERNAME ---------------- */
let userId = localStorage.getItem("username");
if (!userId) {
  userId = prompt("Enter your username:").trim();
  if (!userId) userId = "guest_" + Date.now();
  localStorage.setItem("username", userId);
}

/* ----------- LAST ACTIVE ---------------- */
function updateLastActive() {
  update(ref(db, "chats/" + userId), { lastActive: Date.now() });
}

/* ----------- SOUND EFFECTS ---------------- */
const sendSound = new Audio("https://www.soundjay.com/buttons/sounds/button-3.mp3");
const receiveSound = new Audio("https://www.soundjay.com/buttons/sounds/button-09.mp3");

/* ----------- LOAD MESSAGES ---------------- */
const msgsBox = document.getElementById("msgs");
const typingIndicator = document.getElementById("typingIndicator");

function loadMessages() {
  onValue(ref(db, "chats/" + userId), snap => {
    msgsBox.innerHTML = "";
    snap.forEach(m => {
      const val = m.val();
      if (!val || !val.text) return;
      const d = document.createElement("div");
      d.className = val.from === "admin" ? "msg admin" : "msg user";
      d.innerText = val.text;
      msgsBox.appendChild(d);
      if (val.from === "admin") receiveSound.play();
    });
    msgsBox.scrollTop = msgsBox.scrollHeight;
  });
}

/* ----------- SEND MESSAGE ---------------- */
window.sendMsg = async () => {
  const input = document.getElementById("text");
  if (!input.value) return;

  const snapshot = await get(ref(db, "chats/" + userId + "/blocked"));
  if (snapshot.exists() && snapshot.val() === true) {
    alert("You are blocked by admin! âŒ");
    return;
  }

  updateLastActive();

  push(ref(db, "chats/" + userId), {
    from: "user",
    text: input.value,
    time: Date.now()
  });

  sendSound.play();
  input.value = "";
  update(ref(db, "chats/" + userId), { typing: false });
};

/* ----------- TYPING ---------------- */
let typingTimeout;
const messageInput = document.getElementById("text");

messageInput.addEventListener("input", () => {
  update(ref(db, "chats/" + userId), { typing: true });
  clearTimeout(typingTimeout);
  typingTimeout = setTimeout(() => {
    update(ref(db, "chats/" + userId), { typing: false });
  }, 1000);
});

onValue(ref(db, "chats/admin/typing"), snap => {
  typingIndicator.style.display = snap.val() ? "block" : "none";
});

window.onload = () => {
  updateLastActive();
  setInterval(updateLastActive, 30000);
  loadMessages();
};
</script>

<style>
body{margin:0;font-family:Poppins;background:#0b0a1a;color:#fff}
.app{display:flex;flex-direction:column;height:100vh}
.header{padding:14px;background:#120c22;text-align:center;font-weight:600}
.msgs{flex:1;padding:14px;overflow:auto;display:flex;flex-direction:column}
.msg{padding:10px;border-radius:14px;margin-bottom:8px;max-width:70%;animation:fadeIn .3s}
.msg.admin{background:linear-gradient(135deg,#ff2f6d,#ff8a00)}
.msg.user{background:linear-gradient(135deg,#1e90ff,#00d4ff);margin-left:auto}

#typingIndicator{font-style:italic;color:#aaa;padding:0 14px;margin-bottom:6px}

/* ðŸ”¥ ANIMATED GRADIENT INPUT */
.input{display:flex;padding:10px;align-items:center}
.input-border{
  flex:1;
  padding:2px;
  border-radius:30px;
  background:linear-gradient(270deg,#ff2f6d,#1e90ff,#00d4ff,#ff8a00);
  background-size:600% 600%;
  animation:borderMove 4s ease infinite;
}
.input-border input{
  width:100%;
  padding:12px 14px;
  border:none;
  outline:none;
  border-radius:26px;
  background:#0b0a1a;
  color:#fff;
  font-size:14px;
}

button{
  margin-left:10px;
  border:none;
  border-radius:50%;
  width:42px;
  height:42px;
  background:#ff2f6d;
  color:#fff;
  font-size:18px;
  cursor:pointer;
  transition:.2s;
}
button:hover{transform:scale(1.1)}

@keyframes borderMove{
  0%{background-position:0% 50%}
  50%{background-position:100% 50%}
  100%{background-position:0% 50%}
}
@keyframes fadeIn{
  from{opacity:0;transform:translateY(20px)}
  to{opacity:1;transform:translateY(0)}
}
</style>
</head>

<body>
<div class="app">
  <div class="header">User Chat</div>
  <div class="msgs" id="msgs"></div>
  <div id="typingIndicator">Admin is typing...</div>

  <div class="input">
    <div class="input-border">
      <input id="text" placeholder="Type message..." />
    </div>
    <button onclick="sendMsg()">âž¤</button>
  </div>
</div>
</body>
</html>
